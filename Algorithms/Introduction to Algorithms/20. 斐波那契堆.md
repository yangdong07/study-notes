
斐波那契堆：
优点：
- 不涉及删除元素的操作仅需要 $O(1)$ 的平摊时间
- 适用于 $\text{EXTRACT-MIN}$ 和 $\text{DELTE}$ 操作数目少的情况

缺点：
- 常数因子较大
- 程序设计复杂

## 斐波那契堆

与二项堆一样，也是由一组 最小堆有序树 构成。但堆中的树与二项树有一点区别，为无序二项树。

### 无序二项树
无序二项树的递归定义：
- 无序二项树 $U_0$ 包含一个结点
- 无序二项树 $U_k$ 包含两棵无序二项树 $U_{k-1}$，其中一棵的根结点是另一棵的根结点的任意子结点。

无序二项树 $U_k$ 的性质与二项树的性质基本一致，除了第4点：
1. 共有 $2^k$ 个结点
2. 树的高度为 $k$
3. 在深度 $i$ 处恰有 ${k \choose i}$ 个结点，其中 $i=0, 1, 2, \cdots, k $
4. ** 根的度数为 $k$，它大于任何其他结点的度数；根的子女按某种顺序分别为子树 $U_0, U_1, \cdots, U_{k-1}$ 的根。**

### 斐波那契堆的表示
1. 所有 树 的根组成环形双链表， root list。
2. 每个结点的所有子女也组成环形双链表。

$H$ 具有域：
- $\textit{min}$，指向具有最小关键字的根结点（**最小结点**）
- $\textit{n}$，$H$ 当前所包含的结点个数。

每个结点 $x$ 的域：
- $\textit{degree}$，结点的度（子女数）
- $\textit{left}$，$\textit{right}$，左右兄弟的指针。如果是独子则指向自己。
- $\textit{p}$，父结点指针。
- $\textit{child}$，指向任意一个子女。
- ** $\textit{mark}$ **，表示自从 $x$ 上一次成为另一个结点的子女以来，它是否失去了一个孩子（由 DECREASE-KEY 操作里的 CUT 剪掉了一个结点树枝）。注意：新创建的结点是没有标记的（根结点），使 $x$ 成为另一个结点的子女，也不会标记。

### 斐波那契堆的势函数
用于平摊分析。
定义 斐波那契堆 $H$ 的势为： $$ \Phi(H) = t(H) + 2m(H)$$
其中 $t(H)$ 为 $H$ 的根表中树的数量 ， $m(H)$ 为 $H$ 中有标记结点的个数。
很容易看出：
- 初始势为0
- 势总是非负的

所以由第17章平摊分析可知：对某一操作序列，总的平摊代价的一个上界就是总的实际代价的一个上界。

### 最大度数
在包含 $n$ 个结点的斐波那契堆中，结点的最大度数有一个已知的上界 $D(n)$。
不考虑删除操作， 有$D(n) \le \lfloor \lg n \rfloor $。
考虑删除操作（允许非根内结点少一个孩子），有 $D(n)  \le \lfloor \log_{\phi}{n} \rfloor $，其中 $\phi = (1+\sqrt5) / 2 = 1.61803...$，为黄金分割率。


## 可合并堆的操作
- MAKE-HEAP
- INSERT
- MINIMUM
- EXTRACT-MIN
- UNION

斐波那契堆是一种松散的结构。表现在：
1. 根表无序
2. 二项树无序
3. 在某些操作中（INSERT/UNION），允许同时存在具有相同度数的根结点。只是在特定操作中（EXTRACT-MIN)修复这个性质，令所有根结点的度数不同。
4. 在后面的 EXTRACT-MIN 操作中，会进行“剪枝”操作，允许根结点少任意多的孩子，允许非根内结点少一个孩子，但是要做上标记。

斐波那契堆的主要思想就是把维持堆性质的工作后移。

### $\text{MAKE-FIB-HEAP} ()$
$O(1)$

### $\text{FIB-HEAP-INSERT}(H,x)$
直接将新结点 $x$ 作为根结点插入到根表。并与 $H.min$ 比较，是否成为新的 $H.min$
$O(1)$

### 寻找最小结点
直接返回 $H.min$， $O(1)$

### $\text{FIB-HEAP-UNION}(H_1, H_2)$  合并两个斐波那契堆
简单的将 $H_1$ 和 $H_2$ 两个根表并置，然后确定一个新的最小结点。 $O(1)$

### $\text{FIB-HEAP-EXTRACT-MIN} (H)$  取出最小结点

在抽取最小结点操作里，最终要对堆中的树完成合并（使所有根结点的度数都不相同）
假设操作前，堆中有 $t(H)$ 个树
主要步骤：
1. 把最小结点的子女并置到根表中，移去最小结点。此时堆中至多有 $D(n) + t(H) - 1$ 个树。
2. 对这些树进行合并操作，至少需要遍历一遍，所需时间 $O(D(n) + t(H))$。操作之后留下至多 $D(n) + 1$ 个根（二项堆性质）。

操作中不会标记任何点。所以总的平摊代价至多为：$$ O(D(n)+t(H)) + ((D(n)+1) + 2m(H)) - (t(H) + 2m(H)) = O(D(n)) + O(t(H)) - t(H) = O(D(n))$$  注意上面消除了 $O(t(H)) - t(H)$，这可以通过扩大势的单位来支配$O(t(H))$中隐藏的常数。

直觉上， 每一次链接合并的代价是由势的减少支付的。之前的插入会引起势的增加。
抽取最小结点的实际代价是 $O(D(n) + t(H))$，其中 $t(H)$ 约为 $O(n)$ ，但是平摊代价就只有  $O(D(n)) = O(\lg n)$

_注意这里的平摊意义。为了消除 $O(t(H)) - t(H)$，而增大势的单位，感觉上是增大了常数因子。实际上常数因子与势的单位无关。平摊代价是平摊意义上的平均时间。插入使用的时间较少，但是多支付了势；合并使用的时间较多，但是减少了势。势是抽象的概念，平均时间与单位无关。 _

## 减小一个关键字与删除一个结点（非合并类操作，带有“剪枝”操作）

### $\text{FIB-HEAP-DECREASE-KEY}(H, x, k)$   减小一个关键字
主要步骤
1. 如果 新的 $x$ 的 $k$ 值不小于其父结点（或者 $x$ 本身就是根结点），则堆结构不发生变化。
2. 否则，将 $x$ 与其 父结点 $y$ **切断**，使 $x$ 成为根结点，加入到根表，$x$ 及其子女变成一棵新树。
3. 对父结点 $y$ 进行 CASCADING-CUT 操作：如果 $y$ 是根结点，不处理，且 $y$ 应该是清除了标记的。 如果 $y$ 没有被标记，则表示 $x$ 是第一个被切出去的孩子，此时标记 $y$。否则 $y$ 标记过，表示 $x$ 是第二个被切出去的孩子，将 $y$ 与其父结点 $z$ **切断**，并递归（级联?）的对 $z$ 进行 CASCADING-CUT 操作。

注意这里的堆性质：
1. 对于非根内结点，只允许切出去一个孩子。如果切出去两个孩子，则要将其变成一个新的根结点。
2. 对于根结点，允许切出去任意多的子女。

设递归调用了 $c$ 次 CASCADING-CUT 操作，实际代价是 $O(c)$。
每次调用 CASCADING-CUT，都清除了一个标记（除了最后一次）。操作结束后，树增加了$(c-1) + 1 = c$ 棵，包括 以 $x$ 为根的树和级联切断出去的 $c-1$ 棵树， 标记点至多有 $m(H) - c + 2$ 个，包括级联切断减少的 $c-1$，最后一次级联切断可能给某个结点加上标记。所以势的改变至多为 $$ ((t(H) + c) + 2(m(H) - c + 2)) - (t(H) + 2m(H)) =  4 - c $$  平摊代价至多为 $$O(c) + 4 - c = O(1)$$  可以通过扩大势的单位以支配 $O(c)$ 中的隐含的常数。

这里一个有标记的结点 $y$ 在级联切断中被切断时，其标记位也被清除：势减少2个单位： 一个单位的势用于支付切断和标记位的清除，另一单位的势补偿因结点 $y$ 成为根增加的势。这样才能在式子里产生 $-c$ 项，用于支付整个操作的实际代价 $O(c)$ 。所以势函数中标记结点数量具有常数系数2。

减小一个关键字具有 $ O(c) $约为 $O(\lg n)$ 的实际时间，但其平摊时间为 $O(1)$。

### $\text{FIB-HEAP-DELETE}(H, x)$  
两步：
1. 减小 $x$ 的关键字为 一个最小值，例如 $-\infty$。执行 $\text{FIB-HEAP-DECREASE-KEY}(H, x, -\infty)$， $O(1)$ 的平摊时间
2. 取出最小结点： $\text{FIB-HEAP-EXTRACT-MIN} (H)$


## 最大度数的界 $D(n)$
在上面切断操作中，可以看出：
1. 根结点可以切出去任意多孩子
2. 非根内结点可以切出去至多一个孩子。否则就要变成新的根结点。

_因为斐波那契堆中一棵树的非根内结点可以少一个孩子，且根结点可以少任意多孩子，所以直觉上，与具有相同结点数量 $n$ 的二项树相比，斐波那契堆中的树根的度数应该比 $ \lg n$ 大。_

在这个条件下，对于斐波那契堆里的任一结点 $x$，假设以 $x$ 为根的树中有 $\text{size}(x)$ 个结点，$k$ 为 $x$ 的度数。设以度数为 $k$ 的任意结点为根的子树的最小 $\text{size}$ 为 $s_k$，可以证明：$$ n \ge size(x) \ge s_k \ge F_{k+2} \ge \phi^k$$ 所以 $k \le log_{\phi}n$。所以，任意结点的最大度数 $D(n)$ 为 $O(\lg n)$


## 问题
### 平均时间、平摊时间与常数因子到底有什么关系？？
或者更具体： 平摊时间、实际时间与 势的单位有没有关系。 感觉没关系。
